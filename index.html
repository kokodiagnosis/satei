<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>1åˆ†ã§å®Œçµï¼ç°¡å˜æŸ»å®š | æ ªå¼ä¼šç¤¾ãƒˆãƒªãƒ‹ãƒ†ã‚£</title>
  <style>
    :root {
      --main: #00469b;
      --sub: #ffcf00;
      --bg: #fffcf5;
      --msg-bot: #ffffff;
      --msg-user: #00469b;
      --otoshidama-red: #d62828;
      --otoshidama-gold: #f4a300;
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Sans", "Hiragino Kaku Gothic ProN", sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100dvh;
      overflow: hidden;
    }

    #chat-container {
      flex: 1;
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: white;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 4px 30px rgba(0,0,0,0.05);
      height: 100%;
    }

    /* ========== 2æ®µãƒãƒŠãƒ¼ ========== */
    .header-banners {
      flex-shrink: 0;
      z-index: 11;
    }

    .main-banner {
      background: linear-gradient(135deg, #00469b, #0056b3);
      color: white;
      padding: 12px 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .main-banner h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.5px;
    }
    .main-banner p {
      margin: 4px 0 0;
      font-size: 10px;
      opacity: 0.9;
    }

    .campaign-banner {
      background: linear-gradient(45deg, #d62828, #f4a300, #d62828);
      background-size: 200% auto;
      animation: shine 3s linear infinite;
      color: #fff;
      padding: 10px 8px;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      border-bottom: 2px solid #a31f1f;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      line-height: 1.6;
    }
    .campaign-banner .campaign-main {
      font-size: 14px;
    }
    .campaign-banner .campaign-sub {
      font-size: 11px;
      opacity: 0.95;
      display: block;
      margin-top: 2px;
    }
    @keyframes shine { to { background-position: 200% center; } }

    #chat-log {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 20px 15px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      background: var(--bg);
      padding-bottom: 40px;
    }

    .chat-row { display: flex; align-items: flex-start; gap: 10px; animation: fadeIn 0.4s ease-out; }
    .chat-row.user { justify-content: flex-end; }

    .bot-container { display: flex; flex-direction: column; align-items: center; width: 55px; flex-shrink: 0; }
    .bot-icon { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); object-fit: cover; background: #eee; }
    .bot-name { font-size: 9px; color: #555; margin-top: 4px; text-align: center; line-height: 1.2; font-weight: bold; }

    .msg {
      max-width: 78%;
      padding: 12px 16px;
      font-size: 15px;
      line-height: 1.6;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      word-wrap: break-word;
    }
    .bot { background: var(--msg-bot); border-radius: 4px 20px 20px 20px; color: #444; border: 1px solid #f0eddf; margin-top: 10px; }
    .user { background: var(--msg-user); color: white; border-radius: 20px 20px 4px 20px; }

    .alert-text { color: #d93025; font-weight: bold; border-bottom: 1px solid #d93025; }
    .msg strong { color: #000; font-weight: bold; }
    .msg a { color: #00469b; text-decoration: underline; }

    .privacy-note {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }
    .privacy-note a {
      color: #00469b;
    }

    .video-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: 8px;
      margin-top: 10px;
      border: 1px solid #ddd;
    }
    .video-container iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }

    #input-area {
      padding: 15px;
      border-top: 1px solid #f0eddf;
      background: #fff;
      border-radius: 20px 20px 0 0;
      z-index: 20;
      flex-shrink: 0;
    }
    .options { display: flex; flex-direction: column; gap: 8px; }
    .opt-btn {
      background: #fff;
      border: 2px solid var(--main);
      color: var(--main);
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      text-align: center;
      font-size: 14px;
      transition: 0.3s;
    }
    .opt-btn:hover { background: #f0f7ff; transform: translateY(-1px); }

    input, textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      box-sizing: border-box;
      font-size: 16px;
      margin-bottom: 10px;
      font-family: inherit;
    }
    input:focus, textarea:focus { border-color: var(--main); outline: none; background: #fdfdff; }

    .btn-group { display: flex; gap: 10px; }
    .next-btn {
      flex: 2;
      background: var(--sub);
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
      color: #333;
      box-shadow: 0 4px 0 #e6ba00;
    }
    .next-btn:active { transform: translateY(2px); box-shadow: none; }
    .back-btn {
      flex: 1;
      background: #f5f5f5;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 13px;
      cursor: pointer;
      color: #777;
    }

    .hp-link-btn {
      display: block;
      background: #fff;
      border: 2px solid var(--main);
      color: var(--main);
      padding: 12px;
      border-radius: 12px;
      text-decoration: none;
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .footer-company {
      text-align: center;
      padding: 10px;
      font-size: 10px;
      background: white;
      color: #999;
      border-top: 1px solid #eee;
      flex-shrink: 0;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .typing { display: flex; gap: 5px; padding: 10px; }
    .typing span { width: 8px; height: 8px; background: #d0d0d0; border-radius: 50%; animation: blink 1.2s infinite; }
    @keyframes blink { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

    /* ========== ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º ========== */
    .step-indicator {
      background: linear-gradient(135deg, #fff3cd, #ffeeba);
      border: 2px solid #f4a300;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 15px;
      text-align: center;
      animation: pulseGlow 2s infinite;
    }
    .step-indicator-text {
      font-size: 14px;
      font-weight: bold;
      color: #856404;
    }
    .step-indicator-sub {
      font-size: 12px;
      color: #856404;
      margin-top: 4px;
    }
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 5px rgba(244, 163, 0, 0.3); }
      50% { box-shadow: 0 0 15px rgba(244, 163, 0, 0.6); }
    }

    /* ========== æ”¹è‰¯ç‰ˆï¼šãã˜ã‚¬ã‚µã‚¬ã‚µã‚¢ãƒ‹ãƒ¡ ========== */
    .lottery-teaser {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 15px;
    }

    .lottery-box-container {
      position: relative;
      width: 160px;
      height: 140px;
    }

    /* æŠ½é¸ç®±æœ¬ä½“ */
    .lottery-box {
      width: 140px;
      height: 90px;
      background: linear-gradient(180deg, #c0392b 0%, #96281b 100%);
      border-radius: 8px;
      position: absolute;
      bottom: 0;
      left: 10px;
      box-shadow: 
        0 8px 20px rgba(0,0,0,0.3),
        inset 0 2px 4px rgba(255,255,255,0.2),
        inset 0 -5px 15px rgba(0,0,0,0.3);
      overflow: visible;
    }

    /* ç®±ã®ä¸Šéƒ¨ã®ç©´ */
    .lottery-box::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 16px;
      background: linear-gradient(180deg, #1a1a1a 0%, #333 100%);
      border-radius: 50%;
      box-shadow: inset 0 3px 8px rgba(0,0,0,0.8);
    }

    /* æŠ½é¸ç®±ãƒ©ãƒ™ãƒ« */
    .lottery-box-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #f4d03f, #c9a227);
      color: #8b0000;
      font-size: 16px;
      font-weight: bold;
      padding: 6px 12px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      white-space: nowrap;
      border: 2px solid #a67c00;
    }

    /* ç®±ã®è£…é£¾ãƒ©ã‚¤ãƒ³ */
    .lottery-box::after {
      content: '';
      position: absolute;
      top: 15px;
      left: 10px;
      right: 10px;
      height: 3px;
      background: linear-gradient(90deg, #f4d03f, #fff7cc, #f4d03f);
      border-radius: 2px;
    }

    /* è…•å…¨ä½“ */
    .lottery-arm {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 80px;
      animation: armGasagasa 0.6s ease-in-out infinite;
      transform-origin: center top;
    }

    /* è¢–ï¼ˆæœã®éƒ¨åˆ†ï¼‰ */
    .lottery-sleeve {
      width: 35px;
      height: 50px;
      background: linear-gradient(180deg, #3498db 0%, #2980b9 50%, #1f6dad 100%);
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 8px 8px 12px 12px;
      box-shadow: 
        2px 0 4px rgba(0,0,0,0.2),
        -2px 0 4px rgba(0,0,0,0.2);
    }

    /* è¢–å£ */
    .lottery-sleeve::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: -3px;
      right: -3px;
      height: 8px;
      background: linear-gradient(180deg, #ecf0f1, #bdc3c7);
      border-radius: 0 0 5px 5px;
    }

    /* æ‰‹é¦– */
    .lottery-wrist {
      width: 28px;
      height: 15px;
      background: linear-gradient(180deg, #fce5cd, #f5cba7);
      position: absolute;
      top: 48px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 3px;
    }

    /* æ‰‹ã®ã²ã‚‰ */
    .lottery-hand {
      width: 38px;
      height: 32px;
      background: linear-gradient(180deg, #fdebd0, #f5cba7);
      border-radius: 8px 8px 12px 12px;
      position: absolute;
      top: 58px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 
        0 3px 6px rgba(0,0,0,0.15),
        inset 0 -2px 4px rgba(0,0,0,0.1);
    }

    /* è¦ªæŒ‡ */
    .lottery-thumb {
      width: 12px;
      height: 20px;
      background: linear-gradient(90deg, #fdebd0, #f5cba7);
      border-radius: 6px;
      position: absolute;
      top: 60px;
      left: calc(50% + 16px);
      transform: rotate(20deg);
      box-shadow: 1px 1px 3px rgba(0,0,0,0.15);
    }

    /* æŒ‡ */
    .lottery-fingers {
      position: absolute;
      top: 85px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 2px;
    }

    .lottery-finger {
      width: 8px;
      height: 18px;
      background: linear-gradient(180deg, #fdebd0, #e8c9a0);
      border-radius: 4px;
      box-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }

    .lottery-finger:nth-child(1) { height: 14px; }
    .lottery-finger:nth-child(2) { height: 18px; }
    .lottery-finger:nth-child(3) { height: 17px; }
    .lottery-finger:nth-child(4) { height: 13px; }

    @keyframes armGasagasa {
      0%, 100% { 
        transform: translateX(-50%) rotate(-12deg) translateY(0); 
      }
      25% { 
        transform: translateX(-45%) rotate(8deg) translateY(3px); 
      }
      50% { 
        transform: translateX(-55%) rotate(-8deg) translateY(5px); 
      }
      75% { 
        transform: translateX(-48%) rotate(10deg) translateY(2px); 
      }
    }

    /* æŠ½é¸ç‰ */
    .lottery-balls {
      position: absolute;
      bottom: 15px;
      left: 15px;
      width: 110px;
      height: 35px;
      pointer-events: none;
    }

    .lottery-ball {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      box-shadow: 
        inset -2px -2px 4px rgba(0,0,0,0.2),
        inset 2px 2px 4px rgba(255,255,255,0.5),
        0 2px 4px rgba(0,0,0,0.2);
      animation: ballBounce 0.6s ease-in-out infinite;
    }
    .lottery-ball:nth-child(1) { background: linear-gradient(135deg, #ffd700, #ffec8b); left: 8px; bottom: 8px; animation-delay: 0s; }
    .lottery-ball:nth-child(2) { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); left: 30px; bottom: 12px; animation-delay: 0.1s; }
    .lottery-ball:nth-child(3) { background: linear-gradient(135deg, #4ecdc4, #7ee8e2); left: 52px; bottom: 6px; animation-delay: 0.2s; }
    .lottery-ball:nth-child(4) { background: linear-gradient(135deg, #a55eea, #c490f0); left: 74px; bottom: 10px; animation-delay: 0.15s; }
    .lottery-ball:nth-child(5) { background: linear-gradient(135deg, #26de81, #5ef0a8); left: 90px; bottom: 5px; animation-delay: 0.25s; }

    @keyframes ballBounce {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-8px) rotate(15deg); }
      50% { transform: translateY(-3px) rotate(-10deg); }
      75% { transform: translateY(-10px) rotate(20deg); }
    }

    /* ========== ãŠå¹´ç‰è¢‹ã‚¹ã‚¿ã‚¤ãƒ« ========== */
    .otoshidama-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .otoshidama-envelope {
      width: 180px;
      height: 260px;
      background: linear-gradient(145deg, #e63946, #c1121f);
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      box-shadow: 
        0 10px 30px rgba(198, 18, 18, 0.4),
        inset 0 2px 4px rgba(255,255,255,0.2);
      transition: transform 0.3s, box-shadow 0.3s;
      overflow: hidden;
      animation: envelopeFloat 2s ease-in-out infinite;
    }

    @keyframes envelopeFloat {
      0%, 100% { transform: translateY(0) rotate(-2deg); }
      50% { transform: translateY(-8px) rotate(2deg); }
    }

    .otoshidama-envelope:hover {
      animation: none;
      transform: scale(1.05);
      box-shadow: 
        0 15px 40px rgba(198, 18, 18, 0.5),
        inset 0 2px 4px rgba(255,255,255,0.2);
    }

    .otoshidama-envelope::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: linear-gradient(145deg, #f4a300, #e09200);
      clip-path: polygon(0 0, 100% 0, 100% 40px, 50% 70px, 0 40px);
    }

    .otoshidama-decoration {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 100px;
      background: linear-gradient(145deg, #f4a300, #d4920a);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 
        0 4px 15px rgba(0,0,0,0.2),
        inset 0 2px 4px rgba(255,255,255,0.3);
    }

    .otoshidama-decoration::after {
      content: 'ç¦';
      font-size: 48px;
      font-weight: bold;
      color: #c1121f;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .otoshidama-text {
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      color: #f4a300;
      font-size: 16px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      white-space: nowrap;
    }

    .tap-btn {
      margin-top: 15px;
      background: linear-gradient(145deg, #f4a300, #e09200);
      color: #fff;
      border: none;
      padding: 14px 40px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(244, 163, 0, 0.4);
      animation: tapPulse 1.5s infinite;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    @keyframes tapPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(244, 163, 0, 0.4); }
      50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(244, 163, 0, 0.6); }
    }

    .tap-btn:active {
      transform: scale(0.98);
    }

    /* é–‹å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .otoshidama-envelope.opening {
      animation: envelopeShake 0.6s ease-in-out !important;
    }

    @keyframes envelopeShake {
      0%, 100% { transform: rotate(0deg); }
      20% { transform: rotate(-10deg); }
      40% { transform: rotate(10deg); }
      60% { transform: rotate(-8deg); }
      80% { transform: rotate(8deg); }
    }

    .otoshidama-envelope.opened {
      animation: envelopeOpen 0.8s ease-out forwards !important;
    }

    @keyframes envelopeOpen {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(0); opacity: 0; }
    }

    /* çµæœè¡¨ç¤º */
    .result-container {
      display: none;
      flex-direction: column;
      align-items: center;
      text-align: center;
      animation: resultAppear 0.6s ease-out;
    }

    .result-container.show {
      display: flex;
    }

    @keyframes resultAppear {
      0% { opacity: 0; transform: scale(0.5); }
      50% { transform: scale(1.1); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* å½“é¸æ¼”å‡º */
    .win-container {
      background: linear-gradient(145deg, #ffd700, #ffec8b);
      border-radius: 20px;
      padding: 30px 25px;
      box-shadow: 
        0 10px 40px rgba(255, 215, 0, 0.5),
        0 0 60px rgba(255, 215, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .win-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(
        transparent,
        rgba(255,255,255,0.3),
        transparent,
        rgba(255,255,255,0.3),
        transparent
      );
      animation: sparkleRotate 3s linear infinite;
    }

    @keyframes sparkleRotate {
      100% { transform: rotate(360deg); }
    }

    .win-title {
      font-size: 28px;
      font-weight: bold;
      color: #c1121f;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .win-amount {
      font-size: 42px;
      font-weight: bold;
      color: #d62828;
      margin: 15px 0;
      position: relative;
      z-index: 1;
    }

    .win-subtitle {
      font-size: 16px;
      color: #333;
      position: relative;
      z-index: 1;
      line-height: 1.6;
    }

    .win-notice {
      font-size: 11px;
      color: #666;
      margin-top: 15px;
      padding: 10px;
      background: rgba(255,255,255,0.7);
      border-radius: 8px;
      position: relative;
      z-index: 1;
      line-height: 1.5;
    }

    /* å¤–ã‚Œæ¼”å‡º */
    .lose-container {
      background: linear-gradient(145deg, #f8f9fa, #e9ecef);
      border-radius: 20px;
      padding: 25px 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .lose-title {
      font-size: 20px;
      color: #495057;
      margin-bottom: 15px;
    }

    .second-chance-box {
      background: linear-gradient(145deg, #00469b, #0056b3);
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin-top: 15px;
    }

    .second-chance-title {
      font-size: 18px;
      font-weight: bold;
      color: #ffd700;
      margin-bottom: 10px;
    }

    .second-chance-amount {
      font-size: 32px;
      font-weight: bold;
      color: #fff;
      margin: 10px 0;
    }

    .second-chance-desc {
      font-size: 13px;
      line-height: 1.6;
      opacity: 0.95;
    }

    .second-chance-reason {
      font-size: 11px;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      padding: 10px;
      margin-top: 12px;
      line-height: 1.5;
      text-align: left;
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      top: -10px;
      animation: confettiFall 3s ease-out forwards;
      z-index: 1000;
    }

    @keyframes confettiFall {
      0% { 
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% { 
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* å®Œäº†ç”»é¢ */
    .finish-message {
      background: linear-gradient(145deg, #e8f4fd, #d1e8fa);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
    }
    .finish-message p {
      margin: 0;
      color: #00469b;
      font-size: 15px;
      line-height: 1.6;
    }

  </style>
</head>

<body>
  <div id="chat-container">
    <!-- 2æ®µãƒãƒŠãƒ¼ -->
    <div class="header-banners">
      <div class="main-banner">
        <h1>ğŸ  1åˆ†ã§å®Œçµï¼ç°¡å˜æŸ»å®š</h1>
        <p>by æ ªå¼ä¼šç¤¾ãƒˆãƒªãƒ‹ãƒ†ã‚£</p>
      </div>
      <div class="campaign-banner">
        <span class="campaign-main">ğŸ ãŠå¹´ç‰ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å®Ÿæ–½ä¸­ï¼</span>
        <span class="campaign-sub">ãã®å ´ã§ã‚ã‹ã‚‹âœ¨ æŠ½é¸ã§Amazonã‚®ãƒ•ãƒˆ5,000å††ãŒå½“ãŸã‚‹<br>å¤–ã‚Œã¦ã‚‚é¢è«‡ã«ã¦Amazonã‚®ãƒ•ãƒˆ1ä¸‡å††ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆç¢ºå®šğŸ<br>ã€æœŸé–“é™å®šã€‘</span>
      </div>
    </div>

    <div id="chat-log"></div>
    <div id="input-area"><div id="controls"></div></div>

    <div class="footer-company">
      <a href="https://trinity-111.com" target="_blank" style="color:#666; font-weight:bold;">
        æ ªå¼ä¼šç¤¾ãƒˆãƒªãƒ‹ãƒ†ã‚£ å…¬å¼ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
      </a>
    </div>
  </div>

  <script>
    const log = document.getElementById('chat-log');
    const controls = document.getElementById('controls');
    let userData = {};
    let currentStep = 0;
    let lotteryResult = null; // 'win' or 'lose'

    // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒï¼ˆåŒéšå±¤ã« icon.png ã‚’ç½®ã„ã¦ã­ï¼‰
    const iconImage = "./icon.png";

    // æŠ½é¸ç¢ºç‡ï¼ˆ1/150ï¼‰
    const WIN_PROBABILITY = 1 / 150;

    const allSteps = [
      {
        id: 'intent',
        msg: `ã“ã‚“ã«ã¡ã¯ï¼æŸ»å®šæ‹…å½“ã®è’æœ¨ã§ã™ã€‚<br><br>
<div class="privacy-note">
ğŸ”’ <strong>ç§˜å¯†å³å®ˆ</strong><br>
ã”å…¥åŠ›ã„ãŸã ãå€‹äººæƒ…å ±ã¯å³é‡ã«ç®¡ç†ã—ã€å¼·å¼•ãªå–¶æ¥­é›»è©±ãªã©ã¯ä¸€åˆ‡ã„ãŸã—ã¾ã›ã‚“ã€‚<br>
ã”å®¶æ—ã«çŸ¥ã‚‰ã‚ŒãŸããªã„æ–¹ã‚‚ã”å®‰å¿ƒãã ã•ã„ã€‚æŸ»å®šçµæœã¯ã”æœ¬äººæ§˜ã®ã¿ã«ãŠä¼ãˆã—ã€éƒµé€ç‰©ã‚‚ä¸€åˆ‡ãŠé€ã‚Šã—ã¾ã›ã‚“ã€‚<br>
<a href="https://trinity-111.com/privacy" target="_blank">ğŸ”— ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
</div>
<br>ã¾ãšã¯ã€ç¾åœ¨ã®ã”æ¤œè¨çŠ¶æ³ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ`,
        type: 'options',
        options: ['ã™ãã«å£²ã‚ŠãŸã„', 'åŠå¹´ä»¥å†…ã«æ¤œè¨ã—ãŸã„', 'ã¾ãšã¯ç›¸å ´ã‚’çŸ¥ã‚ŠãŸã„', 'åˆ¥ä½æ‰€ã®ç©ºãå®¶ã‚’ç›¸è«‡ã—ãŸã„']
      },
      {
        id: 'akiya_warning',
        msg: 'ç©ºãå®¶ã®ã”ç›¸è«‡ã§ã™ã­ã€‚å®Ÿã¯ä»Šã€æ”¾ç½®ãƒªã‚¹ã‚¯ãŒéå¸¸ã«é«˜ã¾ã£ã¦ã„ã¾ã™ã€‚<br><br>ğŸš¨ <span class="alert-text">ç›¸ç¶šç™»è¨˜ã®ç¾©å‹™åŒ–</span>ã«ã‚ˆã‚Šã€æ”¾ç½®ã™ã‚‹ã¨éæ–™ï¼ˆç½°å‰‡ï¼‰ã®å¯¾è±¡ã«ã€‚<br>ğŸš¨ ç‰¹å®šç©ºãå®¶æŒ‡å®šã§<span class="alert-text">å›ºå®šè³‡ç”£ç¨ãŒæœ€å¤§6å€</span>ã«è·³ã­ä¸ŠãŒã‚Šã¾ã™ã€‚<br><br>ä¸æ³•æŠ•æ£„ã‚„å®³è™«ã®ç™ºç”Ÿã§è¿‘éš£ãƒˆãƒ©ãƒ–ãƒ«ã«ãªã‚‹å‰ã«ã€ä¸€åº¦å‡ºå£æˆ¦ç•¥ã‚’ç«‹ã¦ã¾ã›ã‚“ã‹ï¼Ÿï¼ˆå…¨å›½å¯¾å¿œå¯èƒ½ã§ã™ï¼ï¼‰',
        type: 'options',
        options: ['ãƒªã‚¹ã‚¯ã‚’ç¢ºèªã—ã¦æŸ»å®šã«é€²ã‚€'],
        condition: () => userData.intent === 'åˆ¥ä½æ‰€ã®ç©ºãå®¶ã‚’ç›¸è«‡ã—ãŸã„'
      },
      {
        id: 'fast_warning',
        msg: 'ã€Œã™ãã«ã€ã¨ã„ã†ã”åˆ¤æ–­ã€ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼<br><br>æ˜¨ä»Šã®<span class="alert-text">é‡‘åˆ©ä¸Šæ˜‡</span>ã«ã‚ˆã‚Šã€ä¸å‹•ç”£ç›¸å ´ã®å…ˆè¡Œãã¯ä¸é€æ˜ã«ãªã‚Šã¤ã¤ã‚ã‚Šã¾ã™ã€‚ã ã‹ã‚‰ã“ãã€<strong>ã€Œä»Šã€ãŒæœ€ã‚‚é«˜ãå£²ã‚Œã‚‹ãƒãƒ£ãƒ³ã‚¹</strong>ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚<br><br>æœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’ã”ææ¡ˆã—ã¾ã™ã®ã§ã€ã¾ãšã¯ä¾¡æ ¼ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼',
        type: 'options',
        options: ['æŸ»å®šã«é€²ã‚€'],
        condition: () => userData.intent === 'ã™ãã«å£²ã‚ŠãŸã„'
      },
      {
        id: 'mid_warning',
        msg: 'åŠå¹´ä»¥å†…ã®ã”æ¤œè¨ã§ã™ã­ã€‚éå¸¸ã«è³¢æ˜ã§ã™ã€‚<br><br>ã—ã‹ã—ã€<span class="alert-text">é‡‘åˆ©ã®ä¸Šæ˜‡å±€é¢</span>ã«å…¥ã‚Šã€åŠå¹´å¾Œã®ç›¸å ´ã¯èª­ã¿ã¥ã‚‰ããªã£ã¦ã„ã¾ã™ã€‚æ—©ã‚ã«ç¾åœ¨ã®ä¾¡å€¤ã‚’çŸ¥ã£ã¦ãŠãã“ã¨ã§ã€ä½™è£•ã‚’æŒã£ã¦ãƒ—ãƒ©ãƒ³ã‚’ç«‹ã¦ã‚‰ã‚Œã¾ã™ã€‚ã¾ãšã¯ç¾çŠ¶ã‚’æŠŠæ¡ã—ã¾ã—ã‚‡ã†ã€‚',
        type: 'options',
        options: ['æŸ»å®šã«é€²ã‚€'],
        condition: () => userData.intent === 'åŠå¹´ä»¥å†…ã«æ¤œè¨ã—ãŸã„'
      },
      {
        id: 'market_warning',
        msg: 'ç›¸å ´ã®æŠŠæ¡ã€ã¨ã¦ã‚‚å¤§åˆ‡ã§ã™ï¼<br><br>å°†æ¥çš„ã«ç©ºãå®¶ã«ãªã‚Œã°<span class="alert-text">å›ºå®šè³‡ç”£ç¨ã®è² æ‹…å¢—</span>ãªã©ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚<strong>ã€Œä»Šã®ä¾¡å€¤ã€ã‚’çŸ¥ã£ã¦ãŠãã“ã¨ãŒæœ€å¤§ã®é˜²å¾¡ç­–</strong>ã§ã™ã€‚ãƒªã‚¹ã‚¯å›é¿ã®ãŸã‚ã«ã‚‚ç¢ºèªã—ã¦ãŠãã¾ã—ã‚‡ã†ï¼',
        type: 'options',
        options: ['ç„¡æ–™ã§ç›¸å ´ã‚’ç¢ºèªã™ã‚‹'],
        condition: () => userData.intent === 'ã¾ãšã¯ç›¸å ´ã‚’çŸ¥ã‚ŠãŸã„'
      },
      {
        id: 'type',
        msg: 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸï¼ç‰©ä»¶ã®ç¨®åˆ¥ã¯ã©ã¡ã‚‰ã§ã—ã‚‡ã†ã‹ï¼Ÿ',
        type: 'options',
        options: ['ãƒãƒ³ã‚·ãƒ§ãƒ³', 'ä¸€æˆ¸å»ºã¦', 'åœŸåœ°', 'ãã®ä»–']
      },
      {
        id: 'zip',
        msg: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚éƒµä¾¿ç•ªå·ã‚’7æ¡ã§å…¥åŠ›ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿä½æ‰€ã‚’è‡ªå‹•ã§ãŠå‘¼ã³ã—ã¾ã™ã€‚',
        type: 'number',
        placeholder: 'ä¾‹: 1234567',
        condition: () => userData.intent !== 'åˆ¥ä½æ‰€ã®ç©ºãå®¶ã‚’ç›¸è«‡ã—ãŸã„'
      },
      {
        id: 'address',
        msg: () => userData.intent === 'åˆ¥ä½æ‰€ã®ç©ºãå®¶ã‚’ç›¸è«‡ã—ãŸã„'
          ? 'ç©ºãå®¶ã®ä½æ‰€ï¼ˆéƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ã‹ã‚‰ï¼‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚'
          : 'ä½æ‰€ã‚„å»ºç‰©åã«é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿä¿®æ­£ã‚‚å¯èƒ½ã§ã™ã€‚<br><br><strong>â€»ãƒãƒ³ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã€å·å®¤ã¾ã§ã”è¨˜å…¥ãã ã•ã„ã€‚</strong>',
        type: 'text',
        placeholder: 'ä¾‹: æ±äº¬éƒ½æ¸¯åŒºã€‡ã€‡ ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³ 402å·å®¤'
      },
      { id: 'unit_type', msg: 'é¢ç©ã®å˜ä½ã¯ã©ã¡ã‚‰ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã‹ï¼Ÿ', type: 'options', options: ['ã¡ï¼ˆå¹³ç±³ï¼‰', 'åªï¼ˆã¤ã¼ï¼‰'] },
      { id: 'area_val', msg: 'ãŠãŠã‚ˆãã®é¢ç©ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ', type: 'number', placeholder: 'æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', suffix: () => userData.unit_type || '' },
      { id: 'house_building_msg', msg: 'å»ºç‰©ï¼ˆæˆ¸å»ºã¦ï¼‰ã®é¢ç©ã‚‚æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ', type: 'number', placeholder: 'æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', condition: () => userData.type === 'ä¸€æˆ¸å»ºã¦', suffix: () => userData.unit_type || '' },
      { id: 'other_detail', msg: 'ã”ç›¸è«‡å†…å®¹ï¼ˆä¾‹ï¼šåº—èˆ—ã€å…±æœ‰åç¾©ã€ç©ºãå®¶ã®çŠ¶æ…‹ãªã©ï¼‰ã‚’è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ', type: 'textarea', placeholder: 'ã“ã¡ã‚‰ã«ã”è¨˜å…¥ãã ã•ã„', condition: () => userData.type === 'ãã®ä»–' || userData.intent === 'åˆ¥ä½æ‰€ã®ç©ºãå®¶ã‚’ç›¸è«‡ã—ãŸã„' },
      { id: 'calculating', msg: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŸã ã„ã¾æœ€æ–°ã®ç›¸å ´äº‹ä¾‹ã¨ãƒªã‚¹ã‚¯å›é¿ç­–ã‚’ä¸€ç”Ÿæ‡¸å‘½ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™...', type: 'loading', duration: 2000 },
      { id: 'name', msg: 'ãŠå¾…ãŸã›ã—ã¾ã—ãŸï¼ç®—å‡ºã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚æœ€å¾Œã«ãŠåå‰ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚', type: 'text', placeholder: 'ä¾‹: ç”°ä¸­ å¤ªéƒ' },
      { 
        id: 'tel', 
        msg: 'ã”é€£çµ¡å…ˆã®é›»è©±ç•ªå·ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚å¼·å¼•ãªå–¶æ¥­ã¯è¡Œã„ã¾ã›ã‚“ã®ã§ã”å®‰å¿ƒãã ã•ã„ã€‚', 
        type: 'tel', 
        placeholder: 'ä¾‹: 09012345678',
        showLotteryTeaser: true,
        remainingSteps: 2
      },
      { 
        id: 'email', 
        msg: 'æœ€å¾Œã§ã™ï¼æŸ»å®šçµæœã‚’ãŠé€ã‚Šã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ', 
        type: 'email', 
        placeholder: 'ä¾‹: mail@example.com',
        showLotteryTeaser: true,
        remainingSteps: 1
      },
      {
        id: 'lottery',
        msg: 'ã™ã¹ã¦ã®ã”å…¥åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ğŸ<br><br>ãŠå¹´ç‰ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®æŠ½é¸ã«ã”å‚åŠ ã„ãŸã ã‘ã¾ã™ã€‚<br>ä¸‹ã®ãŠå¹´ç‰è¢‹ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€é‹è©¦ã—ã—ã¦ã¿ã¦ãã ã•ã„ï¼',
        type: 'lottery'
      },
      {
        id: 'finish',
        msg: '',
        type: 'final'
      }
    ];

    function getActiveSteps() {
      return allSteps.filter(s => !s.condition || s.condition());
    }

    function addMessage(text, side) {
      const row = document.createElement('div');
      row.className = `chat-row ${side}`;

      if (side === 'bot') {
        const container = document.createElement('div');
        container.className = 'bot-container';
        container.innerHTML = `
          <img src="${iconImage}" class="bot-icon" alt="æ‹…å½“è€…" onerror="this.style.display='none'">
          <div class="bot-name">æŸ»å®šæ‹…å½“<br>è’æœ¨</div>
        `;
        row.appendChild(container);
      }

      const msgDiv = document.createElement('div');
      msgDiv.className = `msg ${side}`;
      msgDiv.innerHTML = text;
      row.appendChild(msgDiv);

      log.appendChild(row);
      scrollToBottom();
    }

    function scrollToBottom() { log.scrollTop = log.scrollHeight; }

    // ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function createConfetti() {
      const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#ff9ff3'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
          confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 4000);
        }, i * 50);
      }
    }

    // æŠ½é¸å®Ÿè¡Œ
    function runLottery() {
      return Math.random() < WIN_PROBABILITY;
    }

    // ãã˜ã‚¬ã‚µã‚¬ã‚µã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³HTMLï¼ˆæ”¹è‰¯ç‰ˆï¼‰
    function getLotteryTeaserHTML(remainingSteps) {
      return `
        <div class="lottery-teaser">
          <div class="lottery-box-container">
            <div class="lottery-box">
              <div class="lottery-box-label">æŠ½é¸ç®±</div>
              <div class="lottery-balls">
                <div class="lottery-ball"></div>
                <div class="lottery-ball"></div>
                <div class="lottery-ball"></div>
                <div class="lottery-ball"></div>
                <div class="lottery-ball"></div>
              </div>
            </div>
            <div class="lottery-arm">
              <div class="lottery-sleeve"></div>
              <div class="lottery-wrist"></div>
              <div class="lottery-hand"></div>
              <div class="lottery-thumb"></div>
              <div class="lottery-fingers">
                <div class="lottery-finger"></div>
                <div class="lottery-finger"></div>
                <div class="lottery-finger"></div>
                <div class="lottery-finger"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="step-indicator">
          <div class="step-indicator-text">ğŸ ã‚ã¨${remainingSteps}ã‚¹ãƒ†ãƒƒãƒ—ã§æŠ½é¸é–‹å§‹ï¼</div>
          <div class="step-indicator-sub">Amazonã‚®ãƒ•ãƒˆ5,000å††ãŒå½“ãŸã‚‹ãƒãƒ£ãƒ³ã‚¹</div>
        </div>
      `;
    }

    // ãŠå¹´ç‰è¢‹ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    function openOtoshidama() {
      const envelope = document.querySelector('.otoshidama-envelope');
      const resultContainer = document.querySelector('.result-container');
      const tapBtn = document.querySelector('.tap-btn');
      
      if (!envelope || envelope.classList.contains('opening')) return;
      
      // æŠ½é¸å®Ÿè¡Œ
      const isWin = runLottery();
      lotteryResult = isWin ? 'win' : 'lose';
      userData.lottery_result = lotteryResult;
      
      // ãƒœã‚¿ãƒ³éè¡¨ç¤º
      if (tapBtn) tapBtn.style.display = 'none';
      
      // é–‹å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      envelope.classList.add('opening');
      
      setTimeout(() => {
        envelope.classList.remove('opening');
        envelope.classList.add('opened');
        
        setTimeout(() => {
          envelope.style.display = 'none';
          
          // çµæœè¡¨ç¤º
          if (isWin) {
            createConfetti();
            resultContainer.innerHTML = `
              <div class="win-container">
                <div class="win-title">ğŸŠ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸŠ</div>
                <div class="win-amount">Amazonã‚®ãƒ•ãƒˆ<br>5,000å††åˆ†</div>
                <div class="win-subtitle">å½“é¸ã—ã¾ã—ãŸï¼</div>
                <div class="win-notice">
                  â€»å®Ÿéš›ã®ä½æ‰€ã¨ç•°ãªã‚‹å ´åˆã€è¤‡æ•°å›ã®å¿œå‹Ÿã®å ´åˆã€ç­‰ä¸æ­£ã®æ‰‹æ®µã«ã‚ˆã‚‹æŠ½é¸å¿œå‹Ÿã«é–¢ã—ã¦ã¯ã€å½“é¸ãŒç„¡åŠ¹ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚<br><br>
                  æ‹…å½“ã‚ˆã‚Šç¢ºèªã®ã”é€£çµ¡ã‚’ã„ãŸã—ã¾ã™ã®ã§ã€ä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚
                </div>
              </div>
            `;
          } else {
            resultContainer.innerHTML = `
              <div class="lose-container">
                <div class="lose-title">æ®‹å¿µ...ä»Šå›ã¯ãƒã‚ºãƒ¬ã§ã—ãŸ</div>
                <div class="second-chance-box">
                  <div class="second-chance-title">ğŸ ã‚»ã‚«ãƒ³ãƒ‰ãƒãƒ£ãƒ³ã‚¹ï¼</div>
                  <div class="second-chance-amount">Amazonã‚®ãƒ•ãƒˆ<br>10,000å††åˆ†</div>
                  <div class="second-chance-desc">
                    ã”å£²å´ç›¸è«‡é¢è«‡ã®æˆç«‹ï¼ˆå¯¾é¢ï¼‰ã«ã¦<br>
                    <strong>Amazonã‚®ãƒ•ãƒˆ1ä¸‡å††</strong>ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼<br><br>
                    æŠ½é¸ã‚ˆã‚Šã‚‚ç¢ºå®Ÿã«ã€ã—ã‹ã‚‚2å€ã®é‡‘é¡ã‚’ã‚²ãƒƒãƒˆã§ãã‚‹ãƒãƒ£ãƒ³ã‚¹ã§ã™ã€‚<br>
                    æ‹…å½“ã‚ˆã‚Šã”é€£çµ¡ã„ãŸã—ã¾ã™ã®ã§ã€ãœã²ã”æ¤œè¨ãã ã•ã„ï¼
                  </div>
                  <div class="second-chance-reason">
                    ğŸ’¡ <strong>ãªãœ1ä¸‡å††ï¼Ÿ</strong><br>
                    ä¸å‹•ç”£æ¥­è€…ã¯æœ¬æ¥ã€ä¸€æ‹¬æŸ»å®šã‚µã‚¤ãƒˆã«æœˆæ•°åä¸‡å††ã‹ã‘ã¦åºƒå‘Šã‚’å‡ºã—ã¦ã„ã¾ã™ã€‚ã‚ãˆã¦ã€ãã®ä¸€éƒ¨ã‚’ãŠå®¢æ§˜ã«ç›´æ¥é‚„å…ƒã™ã‚‹ã“ã¨ã§ã€"æœ¬å½“ã«å£²å´ã‚’è€ƒãˆã¦ã„ã‚‹æ–¹"ã«æœ€é«˜ã®ã”ææ¡ˆã‚’å·®ã—ä¸Šã’ãŸã„ã®ã§ã™ã€‚
                  </div>
                </div>
              </div>
            `;
          }
          
          resultContainer.classList.add('show');
          scrollToBottom();
          
          // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          setTimeout(() => {
            controls.innerHTML = `
              <button class="next-btn" onclick="proceedAfterLottery()">æ¬¡ã¸é€²ã‚€</button>
            `;
          }, 1500);
          
        }, 800);
      }, 600);
    }

    function proceedAfterLottery() {
      currentStep++;
      showStep();
      // ãƒ‡ãƒ¼ã‚¿é€ä¿¡
      setTimeout(sendDataToGoogle, 300);
    }

    async function handleInput(val) {
      const activeSteps = getActiveSteps();
      const step = activeSteps[currentStep];

      const value = val ?? document.getElementById('input-field')?.value ?? "";
      if (!value && step.type !== 'loading' && step.type !== 'lottery') return;

      userData[step.id] = value;

      // user message (lotteryã‚¹ãƒ†ãƒƒãƒ—ä»¥å¤–)
      if (step.type !== 'lottery') {
        const row = document.createElement('div');
        row.className = `chat-row user`;
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg user`;
        msgDiv.innerText = value + (step.suffix ? step.suffix() : "");
        row.appendChild(msgDiv);
        log.appendChild(row);
        scrollToBottom();
      }

      // zip auto address
      if (step.id === 'zip') {
        try {
          const res = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${value}`);
          const data = await res.json();
          if (data.results) {
            const r = data.results[0];
            userData['address_auto'] = r.address1 + r.address2 + r.address3;
          }
        } catch (e) {}
      }

      currentStep++;
      showStep();
    }

    function goBack() {
      if (currentStep <= 0) return;

      currentStep--;
      const activeSteps = getActiveSteps();
      log.innerHTML = "";

      for (let i = 0; i < currentStep; i++) {
        const msgText = typeof activeSteps[i].msg === 'function' ? activeSteps[i].msg() : activeSteps[i].msg;
        addMessage(msgText, 'bot');

        if (activeSteps[i].type !== 'lottery') {
          const row = document.createElement('div');
          row.className = `chat-row user`;
          const msgDiv = document.createElement('div');
          msgDiv.className = `msg user`;
          msgDiv.innerText = (userData[activeSteps[i].id] ?? "") + (activeSteps[i].suffix ? activeSteps[i].suffix() : "");
          row.appendChild(msgDiv);
          log.appendChild(row);
        }
      }

      scrollToBottom();
      showStep();
    }

    function showStep() {
      const activeSteps = getActiveSteps();
      if (currentStep >= activeSteps.length) return;

      const step = activeSteps[currentStep];
      const msgText = typeof step.msg === 'function' ? step.msg() : step.msg;

      if (msgText) {
        addMessage(msgText, 'bot');
      }
      scrollToBottom();

      if (step.type === 'loading') {
        controls.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
        setTimeout(() => { currentStep++; showStep(); }, step.duration);
        return;
      }

      if (step.type === 'lottery') {
        controls.innerHTML = `
          <div class="otoshidama-container">
            <div class="otoshidama-envelope" onclick="openOtoshidama()">
              <div class="otoshidama-decoration"></div>
              <div class="otoshidama-text">ãŠå¹´ç‰</div>
            </div>
            <button class="tap-btn" onclick="openOtoshidama()">ğŸ‘† ã‚¿ãƒƒãƒ—ã—ã¦é–‹å°ï¼</button>
            <div class="result-container"></div>
          </div>
        `;
        scrollToBottom();
        return;
      }

      if (step.type === 'options') {
        let html = '<div class="options">';
        step.options.forEach(opt => html += `<button class="opt-btn" onclick="handleInput('${opt}')">${opt}</button>`);
        if (currentStep > 0) html += `<button class="back-btn" onclick="goBack()" style="margin-top:5px;">â† å‰ã¸æˆ»ã‚‹</button>`;
        html += '</div>';
        controls.innerHTML = html;
        return;
      }

      if (step.type === 'final') {
        // å®Œäº†ç”»é¢
        const finishHTML = `
          <div class="finish-message">
            <p>æ‹…å½“ã‚ˆã‚Š<strong>5å–¶æ¥­æ—¥ä»¥å†…</strong>ã«ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚<br>ä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
          </div>
          <div style="text-align:center; margin-bottom:15px; color:#666; font-size:13px;">
            â–¼ ãƒˆãƒªãƒ‹ãƒ†ã‚£ã®æƒ³ã„ï¼ˆå‹•ç”»ï¼‰
          </div>
          <div class="video-container">
            <iframe width="560" height="315" src="https://www.youtube.com/embed/IFcxSeXWO1w?start=3" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
          </div>
        `;
        addMessage(finishHTML, 'bot');
        
        controls.innerHTML = `
          <a href="https://trinity-111.com" target="_blank" class="hp-link-btn">æ ªå¼ä¼šç¤¾ãƒˆãƒªãƒ‹ãƒ†ã‚£ å…¬å¼ã‚µã‚¤ãƒˆ</a>
          <button class="next-btn" onclick="location.reload()">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
        `;
        return;
      }

      const val = (step.id === 'address' && userData['address_auto']) ? userData['address_auto'] : "";
      
      // ãã˜ã‚¬ã‚µã‚¬ã‚µè¡¨ç¤ºåˆ¤å®š
      const lotteryTeaserHTML = step.showLotteryTeaser ? getLotteryTeaserHTML(step.remainingSteps) : '';
      
      const inputHtml = step.type === 'textarea'
        ? `<textarea id="input-field" rows="3" placeholder="${step.placeholder}">${val}</textarea>`
        : `<div style="position:relative;">
             <input type="${step.type}" id="input-field" placeholder="${step.placeholder}" value="${val}">
             ${step.suffix ? `<span style="position:absolute; right:15px; top:14px; color:#888;">${step.suffix()}</span>` : ''}
           </div>`;

      controls.innerHTML = `
        ${lotteryTeaserHTML}
        ${inputHtml}
        <div class="btn-group">
          <button class="back-btn" onclick="goBack()">æˆ»ã‚‹</button>
          <button class="next-btn" onclick="handleInput()">æ¬¡ã¸é€²ã‚€</button>
        </div>
      `;

      setTimeout(() => {
        const input = document.getElementById('input-field');
        if (input) input.focus();
        scrollToBottom();
      }, 100);
    }

    // =========================
    // GASé€ä¿¡
    // =========================
    function sendDataToGoogle() {
      const GAS_URL = "https://script.google.com/macros/s/AKfycbwXMB51IX5FWAMkFWmhJgL_im_OvN24-EwYiYMK3bgz8db_JhSi02crK_lhJgygIAjy/exec";

      let statusEl = document.getElementById("send-status");
      if (!statusEl) {
        statusEl = document.createElement("div");
        statusEl.id = "send-status";
        statusEl.style.marginTop = "10px";
        statusEl.style.fontSize = "12px";
        statusEl.style.fontWeight = "bold";
        const inputArea = document.getElementById("input-area");
        if (inputArea) inputArea.prepend(statusEl);
      }

      statusEl.textContent = "âœ… é€ä¿¡å®Œäº†ï¼ˆå—ä»˜ã—ã¾ã—ãŸï¼‰";
      statusEl.style.color = "#0a7a2f";

      let intentVal = userData.intent || "";
      if (userData.other_detail) intentVal += " (è©³ç´°: " + userData.other_detail + ")";

      let areaStr = userData.area_val || "";
      if (userData.unit_type) areaStr += userData.unit_type;

      let iframe = document.getElementById("hidden_gas_iframe");
      if (!iframe) {
        iframe = document.createElement("iframe");
        iframe.name = "hidden_gas_iframe";
        iframe.id = "hidden_gas_iframe";
        iframe.style.display = "none";
        document.body.appendChild(iframe);
      }

      const form = document.createElement("form");
      form.action = GAS_URL;
      form.method = "POST";
      form.target = "hidden_gas_iframe";

      const add = (name, value) => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = name;
        input.value = value ?? "";
        form.appendChild(input);
      };

      add("intent", intentVal);
      add("type", userData.type || "");
      add("zip", userData.zip || "");
      add("address", userData.address || "");
      add("area", areaStr);
      add("name", userData.name || "");
      add("tel", userData.tel || "");
      add("email", userData.email || "");
      add("lottery_result", userData.lottery_result || "");

      document.body.appendChild(form);
      form.submit();
      form.remove();
    }

    // èµ·å‹•
    showStep();
  </script>
</body>
</html>
